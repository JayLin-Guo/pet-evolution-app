<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spine Dragon - Final Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@esotericsoftware/spine-player@4.2/dist/iife/spine-player.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@esotericsoftware/spine-player@4.2/dist/spine-player.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 20px;
      }
      #info {
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.6;
      }
      #player-container {
        width: 700px;
        height: 700px;
        background: rgba(255, 255, 255, 0.15);
        border: 3px solid rgba(255, 255, 255, 0.4);
        border-radius: 12px;
        margin: 0 auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      button:hover {
        background: #45a049;
      }
      .error {
        color: #ff4444;
        font-weight: bold;
      }
      .success {
        color: #00ff00;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="info">ğŸ”„ åˆå§‹åŒ–ä¸­...</div>
    <div id="player-container"></div>

    <script>
      const info = document.getElementById("info");
      let currentPlayer = null;

      function log(msg, isError = false) {
        const className = isError ? "error" : "success";
        info.innerHTML += `<div class="${className}">${msg}</div>`;
      }

      function loadDragon(usePMA = false) {
        const container = document.getElementById("player-container");
        container.innerHTML = "";

        if (currentPlayer) {
          try {
            currentPlayer.dispose();
          } catch (e) {}
        }

        const folder = "mon_earth_dragon_01";
        const baseUrl = window.location.origin;
        const assetsPath = `${baseUrl}/assets/${folder}/`;

        info.innerHTML = `<b>ğŸ‰ åŠ è½½åœ°é¾™ç´ æ</b><br>
        è·¯å¾„: ${assetsPath}<br>
        é¢„ä¹˜é€æ˜: ${usePMA ? "true" : "false"}<br>
        `;

        try {
          currentPlayer = new spine.SpinePlayer(container, {
            jsonUrl: assetsPath + folder + ".json",
            atlasUrl: assetsPath + folder + ".atlas",
            // ï¼ï¼ï¼å…³é”®ï¼šæ˜ç¡®æŒ‡å®šèµ„æºè·¯å¾„å‰ç¼€
            rawDataURIs: {
              [folder + ".json"]: assetsPath + folder + ".json",
              [folder + ".atlas"]: assetsPath + folder + ".atlas",
              [folder + ".png"]: assetsPath + folder + ".png",
            },
            animation: "idle2",
            premultipliedAlpha: usePMA,
            backgroundColor: "#00000000",
            alpha: true,
            showControls: true,
            debug: { bones: true, regions: true },
            viewport: {
              padLeft: "10%",
              padRight: "10%",
              padTop: "10%",
              padBottom: "10%",
            },
            success: function (player) {
              const anims = player.skeleton.data.animations.map((a) => a.name);
              log(`âœ… åŠ è½½æˆåŠŸï¼`);
              log(`å¯ç”¨åŠ¨ä½œ: ${anims.join(", ")}`);
              info.innerHTML += `
              <button onclick="togglePMA(${!usePMA})">åˆ‡æ¢é€æ˜åº¦ (å½“å‰: ${usePMA})</button>
              <button onclick="toggleDebug()">åˆ‡æ¢è°ƒè¯•æ¨¡å¼</button>
              <button onclick="testAnimation()">æµ‹è¯•åŠ¨ç”»</button>
            `;
            },
            error: function (p, msg) {
              log(`âŒ é”™è¯¯: ${msg}`, true);
            },
          });
        } catch (e) {
          log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${e.message}`, true);
          console.error(e);
        }
      }

      window.togglePMA = function (newValue) {
        loadDragon(newValue);
      };

      window.toggleDebug = function () {
        if (currentPlayer) {
          const currentDebug = currentPlayer.config.debug.bones;
          currentPlayer.config.debug.bones = !currentDebug;
          currentPlayer.config.debug.regions = !currentDebug;
          log(`è°ƒè¯•æ¨¡å¼: ${!currentDebug ? "å¼€å¯" : "å…³é—­"}`);
        }
      };

      window.testAnimation = function () {
        if (currentPlayer) {
          const anims = ["idle2", "attack1a", "attack1c", "idle1"];
          const randomAnim = anims[Math.floor(Math.random() * anims.length)];
          currentPlayer.setAnimation(randomAnim, true);
          log(`æ’­æ”¾åŠ¨ç”»: ${randomAnim}`);
        }
      };

      // é¡µé¢åŠ è½½åè‡ªåŠ¨å¼€å§‹
      window.onload = function () {
        if (typeof spine === "undefined") {
          log("âŒ Spine Player è„šæœ¬åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚", true);
          return;
        }
        log("âœ… Spine Player å·²å°±ç»ª");
        loadDragon(false); // é»˜è®¤ä½¿ç”¨ premultipliedAlpha: false
      };
    </script>
  </body>
</html>
