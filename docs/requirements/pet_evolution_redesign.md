# 宠物进化系统重构需求文档 (PRD)

## 1. 概述

重构宠物系统的数据结构和存储逻辑，支持动态扫描宠物资源、按物种分组、并根据资源数量自动分配进化阶段。引入**宠物专用修真境界**体系，以及基于文件的动态动画发现机制。

## 2. 核心功能

### 2.1. 动态资源扫描与分组

- **源目录**: `D:\petZoom\spine-role`
- **扫描逻辑**:
  - 扫描源文件夹下的所有子目录。
  - **分组逻辑**: 解析目录名称以识别 "物种前缀" 和 "阶段后缀"。
    - 例如: `mon_acorn_girl_01`, `mon_acorn_girl_02` → 组名: `mon_acorn_girl` (物种)。
    - 后缀: `01`, `02` 决定了排序顺序。
  - **阶段分配**: 根据该组中形态的总数量以及当前文件夹的排序顺序，自动分配一个 "境界阶段"。

### 2.2. 宠物境界体系 (经验值)

- 采用宠物专用的修真境界体系。
- **境界**: **幼胎境** → **神胎境** → **化神境** → **地兽** → **天兽** → **鸿蒙神兽**。
- 积累经验值提升境界。
- 达到特定境界后 (如化神境、天兽)，如果物种组中有对应的形态资源，将触发 **进化** (形态变更)。

### 2.3. 动态动画池

- **动画发现**: 对于每个宠物形态文件夹，扫描其中的 `.gif` 文件。
- **逻辑**: `.gif` 的文件名 (如 `idle1.gif`, `attack.gif`) 直接定义了该形态可执行的动作。
- **存储**: 在数据库中存储该形态可用的动画名称列表 (例如 `["idle1", "idle2", "attack"]`)。

---

## 3. 数据库设计方案

### 3.1. `pet_species` (新表 - 物种表)

代表一个宠物的 "家族" 或 "物种" (例如: "橡果娘" 物种)。

| 字段            | 类型     | 描述                                   |
| :-------------- | :------- | :------------------------------------- |
| `id`            | INT (PK) | 唯一物种 ID                            |
| `name`          | VARCHAR  | 物种名称 (例如 "橡果娘")               |
| `folder_prefix` | VARCHAR  | 公共前缀键 (例如 "mon_acorn_girl")     |
| `description`   | TEXT     | 背景故事/描述                          |
| `element`       | ENUM     | 元素属性 (金、木、水、火、土 等，可选) |

### 3.2. `pet_forms` (新表 - 形态表/宠物池)

代表物种的某个具体视觉阶段 (例如 "橡果娘 - 阶段1")。
_注: 不存储与等级挂钩的 `stage_name`，只存储物理属性。_

| 字段                   | 类型     | 描述                                                 |
| :--------------------- | :------- | :--------------------------------------------------- |
| `id`                   | INT (PK) | 唯一形态 ID                                          |
| `species_id`           | INT (FK) | 关联 `pet_species`                                   |
| `rank_order`           | INT      | 物种内的排序 (基于后缀 01, 02...)                    |
| `resource_folder`      | VARCHAR  | 文件夹名称 (例如 "mon_acorn_girl_01")                |
| `available_animations` | JSON     | 扫描到的动画列表 (例如 `["idle1", "feed", "sleep"]`) |

### 3.3. `user_pets` (更新表 - 用户宠物实例)

代表用户拥有的具体宠物实例。

| 字段                | 类型     | 描述                            |
| :------------------ | :------- | :------------------------------ |
| `id`                | INT (PK) | 唯一实例 ID                     |
| `user_id`           | INT (FK) | 拥有者                          |
| `species_id`        | INT (FK) | 关联 `pet_species`              |
| `current_form_id`   | INT (FK) | 关联 `pet_forms` (当前视觉形态) |
| `cultivation_exp`   | BIGINT   | 当前总经验值                    |
| `cultivation_level` | VARCHAR  | 当前境界称号 (例如 "化神境")    |
| `name`              | VARCHAR  | 昵称                            |
| ...                 | ...      | (现有属性: 饥饿值, 快乐值 等)   |

---

## 4. 逻辑规范

### 4.1. 阶段映射算法 (核心逻辑)

根据组内形态文件的**数量**，将排序后的形态映射到具体的**境界**。

**宠物专用境界 (由低到高)**:

1. **幼胎境** (Embryonic Realm)
2. **神胎境** (Divine Embryo Realm)
3. **化神境** (Deification Realm)
4. **地兽** (Earth Beast)
5. **天兽** (Sky Beast)
6. **鸿蒙神兽** (Primordial Divine Beast)

**动态映射逻辑**:

- **如果组内有 3 个形态** (例如 `01`, `02`, `03`):
  - **形态 1** (排序最小) → **幼胎境** (初始阶段)
  - **形态 2** (中间) → **化神境** (第3阶段，提前关键进化)
  - **形态 3** (最大) → **天兽** (第5阶段，高阶进化) 或 **鸿蒙神兽** (巅峰)

- **如果组内有 2 个形态** (例如 `01`, `02`):
  - **形态 1** (排序最小) → **幼胎境** (初始阶段)
  - **形态 2** (最大) → **化神境** (第3阶段，**直接最终进化**，减少等待)

- **如果组内有 1 个形态**:
  - **形态 1** → **幼胎境** (初始阶段)

### 4.2. 宠物境界体系 (经验值对照)

将 `经验值` 映射为 `境界`。

| 境界 (Stage) | 对应的视觉形态 (2形态示例) | 对应的视觉形态 (3形态示例) | 说明                            |
| :----------- | :------------------------- | :------------------------- | :------------------------------ |
| **幼胎境**   | 形态 1                     | 形态 1                     | 初始阶段                        |
| **神胎境**   | -                          | -                          | 积累期                          |
| **化神境**   | **形态 2 (最终)**          | **形态 2 (进化)**          | **关键进化点** (无需等待至鸿蒙) |
| **地兽**     | -                          | -                          | 积累期                          |
| **天兽**     | -                          | **形态 3 (最终)**          | 高阶进化点                      |
| **鸿蒙神兽** | -                          | -                          | 巅峰数值 (视觉不变)             |

_注: 用户必须通过喂养/互动积累经验值，达到特定境界后，宠物才会切换到对应的形态。_

### 4.3. 扫描脚本工作流

1. **遍历 (Glob)** `D:\petZoom\spine-role\*`。
2. **正则匹配**: `^(.+)_(\d+)$` (捕获前缀和数字)。
3. **分组**: 按前缀分组。
4. **遍历每个组**:
   - 创建或更新 `PetSpecies` 记录。
   - 对文件夹按数字进行排序。
   - **不再写入 `stage_name` 到 `PetForm` 表** (仅由逻辑动态计算)。
   - **遍历文件夹**:
     - 扫描目录下的 `*.gif`。
     - 提取文件名 (去后缀)。
     - 保存到 `PetForm.available_animations`。
     - 保存 `PetForm` 记录。

---

## 5. 实施步骤

1. 创建新实体: `PetSpecies`, `PetForm` (已移除 `stage_name`)。
2. 更新 `Pet` 实体。
3. 在 NestJS 服务端实现 `StartScanService` (脚本)。
4. 更新 API 以从 `PetScannerService` 触发扫描。
5. 更新前端以使用新的动态阶段名称和修真境界。
